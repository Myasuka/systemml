Y = read($2, rows=$4, cols=1, rows_per_block=$9, cols_per_block=1, format="binary");
A = read($3, rows=$4, cols=1, rows_per_block=$9, cols_per_block=1, format="binary");

W = $4;

m2Y = centralMoment(Y,2);

accmvarY = m2Y * W
my = sum(Y)/W;

CFreq = ctable(A,1); # groupedAggregate(target=Y, groups=A, fn="count"); # 
R = nrow(CFreq);
print("my", my)
print("R", R)

accumCVars = groupedAggregate(target=Y, groups=A, fn="centralmoment", order=2)*CFreq;
Csum = groupedAggregate(target=Y, groups=A, fn="sum");
CMeans = Csum/CFreq;
sumAccumCVars=sum(accumCVars)
print("sumAccumCVars", sumAccumCVars)
write(Csum, "Csum", format="text");
write(CMeans, "CMeans", format="text");
write(CFreq, "CFreq", format="text");

anova_num_before=sum( CFreq*( (CMeans-my)^2 ) )

print("anova_num_before", anova_num_before)

anova_num = anova_num_before/(R-1.0);

print("anova_num", anova_num)

intermediate= 1-sumAccumCVars/accmvarY;
print("intermediate", intermediate)

Eta = sqrt(intermediate)
print("Eta", Eta)
anova_den = sumAccumCVars/(W-R);
print("anova_den", anova_den)
ANOVAF = anova_num/anova_den;
print("ANOVAF", ANOVAF)

Helper=Rand(rows = 1, cols = 1, min = 1, max = 1);
EtaHelper=Eta*Helper
ANOVAFHelper=ANOVAF*Helper

write(EtaHelper, $6, format="binary");
write(ANOVAFHelper, $7, format="binary");

