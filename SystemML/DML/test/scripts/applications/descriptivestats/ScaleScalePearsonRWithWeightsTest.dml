$$readhelper$$

#X <- scale variable
#Y <- scale variable
#WM <- weights

X = read("$$indir$$X", rows=$$rows$$, cols=1, format="text");
Y = read("$$indir$$Y", rows=$$rows$$, cols=1, format="text");
WM = read("$$indir$$WM", rows=$$rows$$, cols=1, format="text");

W = sum(WM);

# weighted co-variance
covXY = cov(X,Y,WM);

# compute standard deviations for both X and Y by computing 2^nd central moment
m2X = centralMoment(X,WM,2);
m2Y = centralMoment(Y,WM,2);
sigmaX = sqrt(m2X * (W/(W-1.0)) );
sigmaY = sqrt(m2Y * (W/(W-1.0)) );

# Pearson's R
R = covXY / (sigmaX*sigmaY);

PearsonRHelper = R * Helper;
write(PearsonRHelper, "$$outdir$$outPearsonR", format="text");

/*

#----- Unstable Version ----

W = sum(WM);

s1XW = sum(X*WM);
s1YW = sum(Y*WM);

s2XW = sum(X^2*WM);
s2YW = sum(Y^2*WM);

# means
mx = s1XW/W;
my = s1YW/W;

# standard deviation 
sigmaX = sqrt( (s2XW/W - mx*mx) * (W/(W-1)) )
sigmaY = sqrt( (s2YW/W - my*my) * (W/(W-1)) )

# covariance
covXY = sum( WM*(X-mx)*(Y-my) )/(W-1);

# Pearson's R
R = covXY / (sigmaX*sigmaY);

PearsonRHelper = R * Helper;
write(PearsonRHelper, "$$outdir$$outPearsonR", format="text");
*/
